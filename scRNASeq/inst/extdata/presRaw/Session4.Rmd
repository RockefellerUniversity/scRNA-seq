---
title: "Single-cell RNA sequencing ~ Session 3<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>"
author: "Rockefeller University, Bioinformatics Resource Centre"
date: "https://rockefelleruniversity.github.io/scRNA-seq/"
output: 
  xaringan::moon_reader:
    css: ["default", "metropolisCustom.css", "metropolis-fontsCustom.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
  html_document:
    toc: true # table of content true
    toc_float: yes
    depth: 3  # upto three depths of headings (specified by #, ## and ###)
    number_sections: false  ## if you want number sections at each table header
    theme: united  # many options for theme, this one is my favorite.
    highlight: tango  # specifies the syntax highlighting style
params:
  isSlides: "no"
---
```{r setup, include=FALSE}
suppressPackageStartupMessages(require(knitr))
suppressPackageStartupMessages(require(DropletUtils))
suppressPackageStartupMessages(require(SingleCellExperiment))
suppressPackageStartupMessages(require(scran))
suppressPackageStartupMessages(require(scater))
suppressPackageStartupMessages(require(scuttle))
suppressPackageStartupMessages(require(scDblFinder))
knitr::opts_chunk$set(echo = TRUE, tidy = T)

```


## Outline
There are more and more Bioconductor packages supporting single-cell data analysis. R Amezquita, A Lun, S Hicks, and R Gottardo wrote an integrated workflow, [Orchestrating Single-Cell Analysis with Bioconductor](https://bioconductor.org/books/release/OSCA/), for single-cell data analysis and quality assessment. In this session, we will go through several important QC metrics which can't be made with Seurat. 

- How to differentiate empty droplets?
- How to estimate ambient RNA and remove them?
- How to identify doublets?
- Checking for confounded effect?

---
```{r, results='asis',include=TRUE,echo=FALSE}
if(params$isSlides == "yes"){
  cat("class: inverse, center, middle

# Loading data and empty droplets

<html><div style='float:left'></div><hr color='#EB811B' size=1px width=720px></html> 

---
"    
  )
}else{
  cat("#  Loading data and empty drops

---
"    
  )
  
}

```

## Install python libraries
```{r installPythonAndPkgs}

if(!require(reticulate)){
  install.packages("reticulate")
  require(reticulate)
}
if(!dir.exists(reticulate::miniconda_path())){
  install_miniconda()
}
conda_install(
  packages=c("python-igraph","scanpy","louvain")
)



```

---
## Use conda python
```{r usePython}
use_condaenv()
py_config()

```

---
## Load python library
```{r importPython}
sc <- import("scanpy")
sc
```

---
## Install anndata package
```{r installAnnData}
if(!require(anndata)){
  install.packages("anndata")
  require(anndata)
}

```

---
## Download PBMC
```{r downloadPBMC}
pathToDownload <- "http://cf.10xgenomics.com/samples/cell-exp/1.1.0/pbmc3k/pbmc3k_filtered_gene_bc_matrices.tar.gz"
download.file(pathToDownload,"pbmc3k_filtered_gene_bc_matrices.tar.gz")
utils::untar("pbmc3k_filtered_gene_bc_matrices.tar.gz")
```

---
## Read PBMC
```{r readPBMC}
adata <- sc$read_10x_mtx("filtered_gene_bc_matrices/hg19/",
                         var_names="gene_ids") 

adata
```

---
## Dimensions PBMC
```{r dimensions}
dim(adata)
```

---
## Dimnames - PBMC
```{r dimnames}
colnames(adata)[1:3]
rownames(adata)[1:3]
```

---
## Counts- PBMC
```{r countsMatrix}
countsMatrix <- adata$X
countsMatrix[1:2,1:2]
```

---
## Gene information - PBMC
```{r vardf}
var_df <- adata$var
var_df[1:2,,drop=FALSE]
```

---
## Cell information - PBMC
```{r obsdf}
obs_df <- adata$obs
obs_df
rownames(obs_df)[1:2]
```

---
## Cell information - PBMC
```{r addsomeQC}
sc$pp$filter_cells(adata, min_genes=0)
sc$pp$filter_genes(adata, min_cells=0)
```

---
## Cell information - PBMC
```{r obsdf2}
var_df <- adata$var
var_df[1:2,]
```

---
## Cell information - PBMC
```{r vardf2}
obs_df <- adata$obs
obs_df[1:2,,drop=FALSE]
```

---
## Time for an exercise!

Exercise on scRNAseq analysis with Bioconductor can be found [here](../../exercises/exercises/exercise4_exercise.html).

Answers can be found [here](../../exercises/answers/exercise4_answers.html).
